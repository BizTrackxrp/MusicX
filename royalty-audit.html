<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XRP Music ‚Äî Mint Provenance & Royalty Audit</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface-2: #1a1a26;
      --border: #2a2a3a;
      --text: #e8e8f0;
      --text-dim: #8888a0;
      --accent: #3b82f6;
      --red: #ef4444;
      --orange: #f59e0b;
      --green: #22c55e;
      --purple: #a855f7;
      --cyan: #06b6d4;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Grotesk', sans-serif;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 12px; }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .back-link {
      color: var(--text-dim);
      text-decoration: none;
      font-size: 13px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      transition: all 0.15s;
    }
    .back-link:hover { background: var(--surface-2); color: var(--text); }

    .header-right { display: flex; align-items: center; gap: 12px; }

    .wallet-pill {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      padding: 6px 14px;
      border-radius: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--cyan);
    }
    .wallet-pill .dot {
      width: 8px; height: 8px;
      background: var(--green);
      border-radius: 50%;
    }
    .wallet-pill.disconnected .dot { background: var(--text-dim); }
    .wallet-pill.disconnected { color: var(--text-dim); }

    .view-toggle {
      display: flex;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }
    .view-toggle button {
      background: transparent;
      border: none;
      color: var(--text-dim);
      padding: 6px 14px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .view-toggle button:hover { color: var(--text); }
    .view-toggle button.active { background: var(--accent); color: #fff; }

    .refresh-btn {
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      transition: all 0.15s;
    }
    .refresh-btn:hover { background: var(--border); }

    /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 32px;
    }

    /* ‚îÄ‚îÄ Personal Banner ‚îÄ‚îÄ */
    .personal-banner {
      display: none;
      background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(139,92,246,0.08));
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      gap: 24px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .personal-banner.visible { display: flex; }
    .personal-stat { text-align: center; min-width: 100px; }
    .personal-stat .val {
      font-family: 'JetBrains Mono', monospace;
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }
    .personal-stat .label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 2px;
    }
    .personal-stat.warn .val { color: var(--orange); }
    .personal-stat.good .val { color: var(--green); }

    /* ‚îÄ‚îÄ Alert Banner ‚îÄ‚îÄ */
    .alert {
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.25);
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: none;
      align-items: flex-start;
      gap: 12px;
    }
    .alert.visible { display: flex; }
    .alert-icon { font-size: 20px; flex-shrink: 0; margin-top: 1px; }
    .alert-text { font-size: 14px; line-height: 1.5; color: var(--text); }
    .alert-text strong { color: var(--orange); }

    /* ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 28px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 20px;
      cursor: default;
      transition: border-color 0.2s;
    }
    .card.clickable { cursor: pointer; }
    .card.clickable:hover { border-color: var(--accent); }

    .card-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 8px; border-radius: 4px;
      font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .card-badge-og { background: rgba(34,197,94,0.15); color: var(--green); }
    .card-badge-legacy { background: rgba(245,158,11,0.15); color: var(--orange); }
    .card-badge-verified { background: rgba(139,92,246,0.15); color: var(--purple); }

    .card-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .card-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 26px;
      font-weight: 700;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 3px;
    }

    .card--green .card-value { color: var(--green); }
    .card--orange .card-value { color: var(--orange); }
    .card--purple .card-value { color: var(--purple); }
    .card--accent .card-value { color: var(--accent); }
    .card--red .card-value { color: var(--red); }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      width: fit-content;
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: var(--text-dim);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s;
      position: relative;
    }
    .tab-btn:hover { color: var(--text); background: var(--surface-2); }
    .tab-btn.active { background: var(--accent); color: #fff; }

    .tab-count {
      position: absolute;
      top: -4px; right: -4px;
      background: var(--orange);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      padding: 0 5px;
    }

    /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
    .section { display: none; }
    .section.active { display: block; }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .table-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-header h2 {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .table-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-dim);
      background: var(--surface-2);
      padding: 3px 10px;
      border-radius: 4px;
    }

    table { width: 100%; border-collapse: collapse; }

    thead th {
      text-align: left;
      padding: 10px 16px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
      position: sticky;
      top: 0;
    }

    tbody td {
      padding: 10px 16px;
      font-size: 13px;
      border-bottom: 1px solid rgba(42, 42, 58, 0.5);
      vertical-align: middle;
    }

    tbody tr:hover { background: rgba(59, 130, 246, 0.03); }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr.clickable-row { cursor: pointer; }
    tbody tr.clickable-row:hover { background: rgba(59, 130, 246, 0.06); }

    .table-scroll { max-height: 600px; overflow-y: auto; }

    .mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .addr {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--cyan);
      text-decoration: none;
    }
    .addr:hover { text-decoration: underline; }
    .tx-link {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--accent);
      text-decoration: none;
    }
    .tx-link:hover { text-decoration: underline; }
    .xrp { color: var(--orange); }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.3px;
      font-family: 'JetBrains Mono', monospace;
    }
    .badge-og { background: rgba(34,197,94,0.15); color: var(--green); }
    .badge-legacy { background: rgba(245,158,11,0.15); color: var(--orange); }
    .badge-verified { background: rgba(139,92,246,0.15); color: var(--purple); }
    .badge-platform { background: rgba(239,68,68,0.15); color: var(--red); }
    .badge-artist { background: rgba(34,197,94,0.15); color: var(--green); }

    /* ‚îÄ‚îÄ Sale Detail Modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }
    .modal-overlay.visible { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 560px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      padding: 0;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h3 { font-size: 16px; font-weight: 700; }
    .modal-close {
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text);
      width: 32px; height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s;
    }
    .modal-close:hover { background: var(--border); }

    .modal-body { padding: 24px; }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(42,42,58,0.3);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    .detail-value {
      font-size: 14px;
      font-weight: 500;
      text-align: right;
      max-width: 60%;
      word-break: break-all;
    }
    .detail-value a { color: var(--cyan); text-decoration: none; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .detail-value a:hover { text-decoration: underline; }
    .detail-value .xrp-big {
      font-family: 'JetBrains Mono', monospace;
      font-size: 20px;
      font-weight: 700;
      color: var(--orange);
    }

    .royalty-box {
      margin-top: 16px;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
    }
    .royalty-box.issue {
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.2);
    }
    .royalty-box.ok {
      background: rgba(34,197,94,0.08);
      border: 1px solid rgba(34,197,94,0.2);
    }
    .royalty-box .royalty-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    .royalty-box .royalty-amount {
      font-family: 'JetBrains Mono', monospace;
      font-size: 22px;
      font-weight: 700;
    }
    .royalty-box.issue .royalty-amount { color: var(--red); }
    .royalty-box.ok .royalty-amount { color: var(--green); }
    .royalty-box .royalty-note {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 6px;
    }

    /* ‚îÄ‚îÄ Liability Cards ‚îÄ‚îÄ */
    .artist-liability {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .artist-liability-header {
      padding: 14px 20px;
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer;
      transition: background 0.15s;
    }
    .artist-liability-header:hover { background: var(--surface-2); }
    .artist-liability-name { font-weight: 600; font-size: 14px; }
    .artist-liability-owed {
      font-family: 'JetBrains Mono', monospace;
      font-size: 15px;
      color: var(--orange);
      font-weight: 700;
    }
    .artist-liability-detail {
      display: none;
      border-top: 1px solid var(--border);
    }
    .artist-liability.open .artist-liability-detail { display: block; }

    /* ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
    .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
    .empty-state p { font-size: 14px; line-height: 1.6; }

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    .loading { text-align: center; padding: 60px 20px; color: var(--text-dim); font-size: 14px; }
    .spinner {
      display: inline-block; width: 24px; height: 24px;
      border: 2px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .header { padding: 12px 16px; flex-wrap: wrap; gap: 8px; }
      .header-right { width: 100%; justify-content: space-between; }
      .summary-grid { grid-template-columns: 1fr 1fr; }
      thead th, tbody td { padding: 8px 10px; font-size: 11px; }
      .table-scroll { max-height: 400px; }
      .personal-banner { flex-direction: column; align-items: flex-start; gap: 16px; }
      .modal { margin: 10px; max-height: 90vh; }
      .tabs { overflow-x: auto; width: 100%; }
      .view-toggle { display: none; }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-left">
      <a href="app.html" class="back-link">‚Üê App</a>
      <h1>üîç Mint Provenance & Royalty Audit</h1>
    </div>
    <div class="header-right">
      <div class="wallet-pill disconnected" id="walletPill">
        <div class="dot"></div>
        <span id="walletAddr">Not connected</span>
      </div>
      <div class="view-toggle" id="viewToggle" style="display:none;">
        <button class="active" onclick="setView('personal', this)">My Releases</button>
        <button onclick="setView('global', this)">Platform</button>
      </div>
      <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
    </div>
  </div>

  <div class="container">
    <!-- Personal Banner (logged in artists) -->
    <div class="personal-banner" id="personalBanner">
      <div class="personal-stat">
        <div class="val" id="myReleases">‚Äî</div>
        <div class="label">Your Releases</div>
      </div>
      <div class="personal-stat good">
        <div class="val" id="myOgCount">‚Äî</div>
        <div class="label">OG Mints</div>
      </div>
      <div class="personal-stat warn">
        <div class="val" id="myLegacyCount">‚Äî</div>
        <div class="label">Legacy</div>
      </div>
      <div class="personal-stat">
        <div class="val" id="mySecondarySales">‚Äî</div>
        <div class="label">Secondary Sales</div>
      </div>
      <div class="personal-stat warn">
        <div class="val" id="myRoyaltyOwed">‚Äî</div>
        <div class="label">Royalty Owed</div>
      </div>
    </div>

    <!-- Alert Banner -->
    <div class="alert" id="alertBanner">
      <div class="alert-icon">‚ö†Ô∏è</div>
      <div class="alert-text" id="alertText"></div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-grid" id="summaryGrid">
      <div class="loading"><div class="spinner"></div><br>Loading...</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showSection('secondary', this)" id="tabSecondary">
        Secondary Sales
      </button>
      <button class="tab-btn" onclick="showSection('audit', this)">Releases</button>
      <button class="tab-btn" onclick="showSection('liability', this)">Royalty Liability</button>
    </div>

    <!-- Secondary Sales Section -->
    <div class="section active" id="section-secondary">
      <div id="secondaryContent">
        <div class="loading"><div class="spinner"></div><br>Loading secondary sales...</div>
      </div>
    </div>

    <!-- Mint Audit Section -->
    <div class="section" id="section-audit">
      <div id="auditContent">
        <div class="loading"><div class="spinner"></div><br>Loading releases...</div>
      </div>
    </div>

    <!-- Royalty Liability Section -->
    <div class="section" id="section-liability">
      <div id="liabilityContent">
        <div class="loading"><div class="spinner"></div><br>Loading...</div>
      </div>
    </div>
  </div>

  <!-- Sale Detail Modal -->
  <div class="modal-overlay" id="saleModal" onclick="if(event.target===this)closeSaleModal()">
    <div class="modal">
      <div class="modal-header">
        <h3>Secondary Sale Details</h3>
        <button class="modal-close" onclick="closeSaleModal()">‚úï</button>
      </div>
      <div class="modal-body" id="saleModalBody">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/royalty-audit';
    let currentWallet = null;
    let currentView = 'global'; // 'global' or 'personal'

    // ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ
    function truncAddr(addr) {
      if (!addr) return '‚Äî';
      return addr.slice(0, 6) + '‚Ä¶' + addr.slice(-4);
    }

    function xrpFmt(val) {
      const n = parseFloat(val) || 0;
      return n < 0.01 && n > 0 ? n.toFixed(6) : n.toFixed(2);
    }

    function dateFmt(d) {
      if (!d) return '‚Äî';
      return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function timeFmt(d) {
      if (!d) return '';
      return new Date(d).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function badgeHtml(type) {
      if (type === 'og') return '<span class="badge badge-og">‚õè OG MINT</span>';
      if (type === 'legacy') return '<span class="badge badge-legacy">‚ö† LEGACY</span>';
      if (type === 'verified') return '<span class="badge badge-verified">‚úì VERIFIED</span>';
      return '';
    }

    function issuerBadge(recipient) {
      if (recipient === 'platform_wallet') return '<span class="badge badge-platform">Platform ‚úó</span>';
      return '<span class="badge badge-artist">Artist ‚úì</span>';
    }

    // ‚îÄ‚îÄ Wallet Detection ‚îÄ‚îÄ
   function detectWallet() {
      // Read from sessionStorage where Xaman auth stores the session
      let stored = null;
      try {
        const session = sessionStorage.getItem('xrpmusic_session');
        if (session) {
          const parsed = JSON.parse(session);
          stored = parsed.address || null;
        }
      } catch (e) {}
      
      // Also check URL param for direct linking
      const urlParams = new URLSearchParams(window.location.search);
      const paramWallet = urlParams.get('wallet');
      
      currentWallet = paramWallet || stored || null;
      
      const pill = document.getElementById('walletPill');
      const addrEl = document.getElementById('walletAddr');
      const toggle = document.getElementById('viewToggle');
      
      if (currentWallet) {
        pill.classList.remove('disconnected');
        addrEl.textContent = truncAddr(currentWallet);
        toggle.style.display = 'flex';
        currentView = 'personal';
        toggle.querySelectorAll('button')[0].classList.add('active');
        toggle.querySelectorAll('button')[1].classList.remove('active');
      } else {
        pill.classList.add('disconnected');
        addrEl.textContent = 'Not connected';
        toggle.style.display = 'none';
        currentView = 'global';
      }
    }
      
      // Also check URL param for direct linking
      const urlParams = new URLSearchParams(window.location.search);
      const paramWallet = urlParams.get('wallet');
      
      currentWallet = paramWallet || stored || null;
      
      const pill = document.getElementById('walletPill');
      const addrEl = document.getElementById('walletAddr');
      const toggle = document.getElementById('viewToggle');
      
      if (currentWallet) {
        pill.classList.remove('disconnected');
        addrEl.textContent = truncAddr(currentWallet);
        toggle.style.display = 'flex';
        currentView = 'personal';
        // Set personal button active
        toggle.querySelectorAll('button')[0].classList.add('active');
        toggle.querySelectorAll('button')[1].classList.remove('active');
      } else {
        pill.classList.add('disconnected');
        addrEl.textContent = 'Not connected';
        toggle.style.display = 'none';
        currentView = 'global';
      }
    }

    function setView(view, btn) {
      currentView = view;
      document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Show/hide personal banner
      document.getElementById('personalBanner').classList.toggle('visible', view === 'personal' && currentWallet);
      
      loadAll();
    }

    function getWalletParam() {
      return (currentView === 'personal' && currentWallet) ? `&wallet=${currentWallet}` : '';
    }

    function showSection(name, btn) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('section-' + name).classList.add('active');
      btn.classList.add('active');
    }

    // ‚îÄ‚îÄ Sale Detail Modal ‚îÄ‚îÄ
    function openSaleModal(sale) {
      const modal = document.getElementById('saleModal');
      const body = document.getElementById('saleModalBody');
      
      const isIssue = sale.royaltyRecipient === 'platform_wallet';
      const trackName = sale.track_title || sale.release_title || 'Unknown Track';
      
      body.innerHTML = `
        <div style="margin-bottom:20px;text-align:center;">
          <div style="font-size:18px;font-weight:700;margin-bottom:4px;">${trackName}</div>
          <div style="color:var(--text-dim);font-size:13px;">by ${sale.artist_name || '‚Äî'}</div>
          <div style="margin-top:8px;">${badgeHtml(sale.badgeType)}</div>
        </div>

        <div class="detail-row">
          <span class="detail-label">Sale Price</span>
          <span class="detail-value"><span class="xrp-big">${xrpFmt(sale.price)} XRP</span></span>
        </div>

        <div class="detail-row">
          <span class="detail-label">Date</span>
          <span class="detail-value">${dateFmt(sale.created_at || sale.sale_date)} ${timeFmt(sale.created_at || sale.sale_date)}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label">Seller</span>
          <span class="detail-value"><a href="https://bithomp.com/explorer/${sale.seller_address}" target="_blank">${sale.seller_address || '‚Äî'}</a></span>
        </div>

        <div class="detail-row">
          <span class="detail-label">Buyer</span>
          <span class="detail-value"><a href="https://bithomp.com/explorer/${sale.buyer_address}" target="_blank">${sale.buyer_address || '‚Äî'}</a></span>
        </div>

        <div class="detail-row">
          <span class="detail-label">Artist</span>
          <span class="detail-value"><a href="https://bithomp.com/explorer/${sale.artist_address}" target="_blank">${sale.artist_address || '‚Äî'}</a></span>
        </div>

        ${sale.nft_token_id ? `<div class="detail-row">
          <span class="detail-label">NFT ID</span>
          <span class="detail-value"><a href="https://bithomp.com/nft/${sale.nft_token_id}" target="_blank">${truncAddr(sale.nft_token_id)}</a></span>
        </div>` : ''}

        ${sale.edition_number ? `<div class="detail-row">
          <span class="detail-label">Edition</span>
          <span class="detail-value">#${sale.edition_number}</span>
        </div>` : ''}

        ${sale.tx_hash ? `<div class="detail-row">
          <span class="detail-label">Transaction</span>
          <span class="detail-value"><a href="https://bithomp.com/explorer/${sale.tx_hash}" target="_blank">${sale.tx_hash.slice(0, 12)}‚Ä¶</a></span>
        </div>` : ''}

        <div class="detail-row">
          <span class="detail-label">On-Chain Issuer</span>
          <span class="detail-value">${issuerBadge(sale.royaltyRecipient)}</span>
        </div>

        <div class="royalty-box ${isIssue ? 'issue' : 'ok'}">
          <div class="royalty-label">${isIssue ? 'Royalty Owed to Artist' : 'Royalty Paid to Artist'}</div>
          <div class="royalty-amount">${xrpFmt(sale.estimatedRoyalty || 0)} XRP</div>
          <div class="royalty-note">
            ${isIssue 
              ? 'This is a LEGACY mint ‚Äî royalty routed to platform wallet. Will be manually forwarded to artist.'
              : 'Royalty flowed directly to the artist on-chain. No action needed.'}
          </div>
        </div>
      `;
      
      modal.classList.add('visible');
    }

    function closeSaleModal() {
      document.getElementById('saleModal').classList.remove('visible');
    }

    // Close on Escape
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeSaleModal(); });

    // ‚îÄ‚îÄ Load Summary ‚îÄ‚îÄ
    async function loadSummary() {
      try {
        const res = await fetch(API_BASE + '?action=summary' + getWalletParam());
        const s = await res.json();

        const hasIssue = s.royaltyIssue.affectedSalesCount > 0;

        // Alert banner
        if (hasIssue) {
          document.getElementById('alertBanner').classList.add('visible');
          document.getElementById('alertText').innerHTML = `
            <strong>${s.royaltyIssue.affectedSalesCount} secondary sale(s)</strong> on lazy-minted NFTs detected.
            Estimated <strong>${xrpFmt(s.royaltyIssue.estimatedRoyaltyOwed)} XRP</strong> in royalties
            may need manual forwarding to <strong>${s.royaltyIssue.affectedArtists} artist(s)</strong>.
          `;
        } else {
          document.getElementById('alertBanner').classList.remove('visible');
        }

        // Personal banner
        if (s.personal && currentView === 'personal') {
          const pb = document.getElementById('personalBanner');
          pb.classList.add('visible');
          document.getElementById('myReleases').textContent = s.personal.releases.total;
          document.getElementById('myOgCount').textContent = s.personal.releases.preMint;
          document.getElementById('myLegacyCount').textContent = s.personal.releases.lazyMint;
          document.getElementById('mySecondarySales').textContent = s.personal.secondarySales.count;
          document.getElementById('myRoyaltyOwed').textContent = 
            s.personal.royaltyOwed > 0 ? xrpFmt(s.personal.royaltyOwed) + ' XRP' : '0';
        } else {
          document.getElementById('personalBanner').classList.remove('visible');
        }

        // Summary cards
        document.getElementById('summaryGrid').innerHTML = `
          <div class="card">
            <div class="card-badge card-badge-og">‚õè OG MINT</div>
            <div class="card-value" style="color:var(--green);">${s.releases.preMint}</div>
            <div class="card-sub">Pre-Lazy-Mint Releases<br>Artist = on-chain issuer ‚úì</div>
          </div>
          <div class="card">
            <div class="card-badge card-badge-legacy">‚ö† LEGACY</div>
            <div class="card-value" style="color:var(--orange);">${s.releases.lazyMint}</div>
            <div class="card-sub">Lazy-Mint (Pre-Fix)<br>Platform = on-chain issuer</div>
          </div>
          <div class="card">
            <div class="card-badge card-badge-verified">‚úì VERIFIED</div>
            <div class="card-value" style="color:var(--purple);">‚Äî</div>
            <div class="card-sub">Lazy-Mint (Post-Fix)<br>Fix not yet deployed</div>
          </div>
          <div class="card clickable" onclick="showSection('secondary', document.getElementById('tabSecondary')); document.getElementById('tabSecondary').classList.add('active');">
            <div class="card-label">Secondary Sales</div>
            <div class="card-value" style="color:var(--accent);">${s.secondarySales.count}</div>
            <div class="card-sub">${xrpFmt(s.secondarySales.volume)} XRP volume ¬∑ Click for details</div>
          </div>
        `;

      } catch (err) {
        document.getElementById('summaryGrid').innerHTML = `
          <div class="card"><div class="card-label">Error</div><div style="color:var(--red);font-size:13px;">${err.message}</div></div>
        `;
      }
    }

    // ‚îÄ‚îÄ Load Secondary Sales ‚îÄ‚îÄ
    let cachedSecondarySales = [];

    async function loadSecondarySales() {
      try {
        const res = await fetch(API_BASE + '?action=secondary-sales' + getWalletParam());
        const data = await res.json();
        cachedSecondarySales = data.secondarySales;

        // Update tab count badge
        const tabBtn = document.getElementById('tabSecondary');
        const existing = tabBtn.querySelector('.tab-count');
        if (existing) existing.remove();
        if (data.totalCount > 0) {
          const badge = document.createElement('span');
          badge.className = 'tab-count';
          badge.textContent = data.totalCount;
          tabBtn.appendChild(badge);
        }

        if (data.secondarySales.length === 0) {
          document.getElementById('secondaryContent').innerHTML = `
            <div class="empty-state">
              <div class="emoji">üéâ</div>
              <p>No secondary sales recorded yet.<br>
              ${currentView === 'personal' ? 'When your NFTs get resold, they\'ll appear here.' : 'When collectors resell NFTs, they\'ll show here.'}</p>
            </div>
          `;
          return;
        }

        let rows = '';
        for (const sale of data.secondarySales) {
          const trackName = sale.track_title || sale.release_title;
          rows += `<tr class="clickable-row" onclick='openSaleModal(${JSON.stringify(sale).replace(/'/g, "&#39;")})'>
            <td>${dateFmt(sale.created_at)}</td>
            <td>
              <strong>${trackName}</strong><br>
              <span style="color:var(--text-dim);font-size:11px;">by ${sale.artist_name}</span>
            </td>
            <td><span class="mono xrp">${xrpFmt(sale.price)} XRP</span></td>
            <td>${badgeHtml(sale.badgeType)}</td>
            <td>${issuerBadge(sale.royaltyRecipient)}</td>
            <td><span class="mono xrp">${xrpFmt(sale.estimatedRoyalty)}</span></td>
            <td>
              <a class="addr" href="https://bithomp.com/explorer/${sale.seller_address}" target="_blank" onclick="event.stopPropagation()">${truncAddr(sale.seller_address)}</a>
              ‚Üí <a class="addr" href="https://bithomp.com/explorer/${sale.buyer_address}" target="_blank" onclick="event.stopPropagation()">${truncAddr(sale.buyer_address)}</a>
            </td>
            <td>${sale.tx_hash ? `<a class="tx-link" href="https://bithomp.com/explorer/${sale.tx_hash}" target="_blank" onclick="event.stopPropagation()">${sale.tx_hash.slice(0, 8)}‚Ä¶</a>` : '‚Äî'}</td>
          </tr>`;
        }

        document.getElementById('secondaryContent').innerHTML = `
          <div class="table-wrap">
            <div class="table-header">
              <h2>Secondary Market Sales</h2>
              <span class="table-count">${data.totalCount} sale${data.totalCount !== 1 ? 's' : ''} ¬∑ ${xrpFmt(data.totalRoyaltyOwedToArtists)} XRP owed</span>
            </div>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Track</th>
                    <th>Price</th>
                    <th>Badge</th>
                    <th>Royalty To</th>
                    <th>Royalty</th>
                    <th>Seller ‚Üí Buyer</th>
                    <th>Tx</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
          <p style="font-size:12px;color:var(--text-dim);margin-top:8px;text-align:center;">
            Click any row for full transaction details
          </p>
        `;

      } catch (err) {
        document.getElementById('secondaryContent').innerHTML = `<div class="loading" style="color:var(--red);">Error: ${err.message}</div>`;
      }
    }

    // ‚îÄ‚îÄ Load Mint Audit ‚îÄ‚îÄ
    async function loadMintAudit() {
      try {
        const res = await fetch(API_BASE + '?action=mint-audit' + getWalletParam());
        const data = await res.json();

        function buildTable(releases, title, badgeType) {
          if (releases.length === 0) return '';

          let rows = '';
          for (const r of releases) {
            const sold = r.sold_editions || 0;
            const total = r.total_editions || '‚àû';
            rows += `<tr>
              <td><strong>${r.title}</strong> <span class="badge badge-${r.type === 'album' ? 'legacy' : ''}" style="font-size:10px;background:rgba(255,255,255,0.05);color:var(--text-dim);">${r.type || 'single'}</span></td>
              <td>${r.artist_name}</td>
              <td class="mono">${r.track_count || 1}</td>
              <td class="mono">${sold} / ${total}</td>
              <td class="mono">${r.royalty_percent || 5}%</td>
              <td>${issuerBadge(r.royaltyRecipient)}</td>
              <td style="font-size:11px;color:var(--text-dim);">${dateFmt(r.created_at)}</td>
            </tr>`;
          }

          return `
            <div class="table-wrap" style="margin-bottom:20px;">
              <div class="table-header">
                <h2>${badgeHtml(badgeType)} ${title}</h2>
                <span class="table-count">${releases.length}</span>
              </div>
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr>
                      <th>Release</th>
                      <th>Artist</th>
                      <th>Tracks</th>
                      <th>Sold</th>
                      <th>Royalty</th>
                      <th>Issuer</th>
                      <th>Created</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
            </div>
          `;
        }

        const html = 
          buildTable(data.releases.preLazyMint, 'Pre-Lazy-Mint Releases', 'og') +
          buildTable(data.releases.lazyMint, 'Lazy-Mint Releases (Pre-Fix)', 'legacy') +
          buildTable(data.releases.verified, 'Verified Releases (Post-Fix)', 'verified');

        document.getElementById('auditContent').innerHTML = html || `
          <div class="empty-state">
            <div class="emoji">üìÄ</div>
            <p>${currentView === 'personal' ? 'You haven\'t released any music yet.' : 'No releases found.'}</p>
          </div>
        `;

      } catch (err) {
        document.getElementById('auditContent').innerHTML = `<div class="loading" style="color:var(--red);">Error: ${err.message}</div>`;
      }
    }

    // ‚îÄ‚îÄ Load Royalty Liability ‚îÄ‚îÄ
    async function loadRoyaltyLiability() {
      try {
        const res = await fetch(API_BASE + '?action=royalty-liability' + getWalletParam());
        const data = await res.json();

        if (data.artists.length === 0) {
          document.getElementById('liabilityContent').innerHTML = `
            <div class="empty-state">
              <div class="emoji">‚úÖ</div>
              <p>No royalty liability detected.<br>No secondary sales on legacy-minted NFTs have occurred${currentView === 'personal' ? ' for your releases' : ''} yet.</p>
            </div>
          `;
          return;
        }

        let html = `
          <div class="card" style="margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;border-color:rgba(245,158,11,0.3);">
            <div>
              <div class="card-label">Total Royalty Liability</div>
              <div class="card-sub">${data.totalSecondarySales} secondary sale(s) across ${data.artists.length} artist(s)</div>
            </div>
            <div class="card-value" style="color:var(--orange);">${xrpFmt(data.grandTotalOwed)} XRP</div>
          </div>
        `;

        for (const artist of data.artists) {
          let saleRows = '';
          for (const s of artist.sales) {
            saleRows += `<tr class="clickable-row" onclick='openSaleModal(${JSON.stringify(s).replace(/'/g, "&#39;")})'>
              <td>${dateFmt(s.sale_date)}</td>
              <td>${s.track_title || s.release_title}</td>
              <td class="mono xrp">${xrpFmt(s.price)} XRP</td>
              <td class="mono">${s.royaltyPercent}%</td>
              <td class="mono xrp">${xrpFmt(s.royaltyOwed)} XRP</td>
              <td>
                <a class="addr" href="https://bithomp.com/explorer/${s.seller_address}" target="_blank" onclick="event.stopPropagation()">${truncAddr(s.seller_address)}</a>
              </td>
              <td>${s.tx_hash ? `<a class="tx-link" href="https://bithomp.com/explorer/${s.tx_hash}" target="_blank" onclick="event.stopPropagation()">${s.tx_hash.slice(0, 8)}‚Ä¶</a>` : '‚Äî'}</td>
            </tr>`;
          }

          html += `
            <div class="artist-liability" onclick="this.classList.toggle('open')">
              <div class="artist-liability-header">
                <div>
                  <div class="artist-liability-name">${artist.artistName}</div>
                  <a class="addr" href="https://bithomp.com/explorer/${artist.artistAddress}" target="_blank" onclick="event.stopPropagation()">${truncAddr(artist.artistAddress)}</a>
                  <span style="color:var(--text-dim);font-size:11px;margin-left:8px;">${artist.sales.length} sale(s)</span>
                </div>
                <div class="artist-liability-owed">${xrpFmt(artist.totalOwed)} XRP</div>
              </div>
              <div class="artist-liability-detail">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Track</th>
                      <th>Sale Price</th>
                      <th>Royalty %</th>
                      <th>Owed</th>
                      <th>Reseller</th>
                      <th>Tx</th>
                    </tr>
                  </thead>
                  <tbody>${saleRows}</tbody>
                </table>
              </div>
            </div>
          `;
        }

        document.getElementById('liabilityContent').innerHTML = html;

      } catch (err) {
        document.getElementById('liabilityContent').innerHTML = `<div class="loading" style="color:var(--red);">Error: ${err.message}</div>`;
      }
    }

    // ‚îÄ‚îÄ Load All ‚îÄ‚îÄ
    async function loadAll() {
      loadSummary();
      loadSecondarySales();
      loadMintAudit();
      loadRoyaltyLiability();
    }

    // ‚îÄ‚îÄ Initialize ‚îÄ‚îÄ
    detectWallet();
    loadAll();
  </script>

</body>
</html>
